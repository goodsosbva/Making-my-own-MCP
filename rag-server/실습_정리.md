# MCP 서버와 RAG 시스템 실습 정리

## 📋 실습 개요

이번 실습에서는 **MCP(Model Context Protocol) 서버**를 구축하고, **LangChain**을 활용한 **RAG(Retrieval-Augmented Generation) 시스템**을 구현했습니다.

### 🎯 실습 목표

- MCP 서버의 개념과 구조 이해
- LangChain 프레임워크 활용법 학습
- RAG 시스템 구축 및 활용
- PDF 문서 기반 질문응답 시스템 구현
- 보안을 고려한 API 키 관리 방법 학습

---

## 🔧 MCP 서버란?

**MCP(Model Context Protocol)**는 AI 모델과 다양한 도구, 데이터 소스를 연결하는 표준 프로토콜입니다.

### 주요 특징

- **도구 등록**: 다양한 기능을 도구로 등록하여 AI가 활용할 수 있게 함
- **프로토콜 표준화**: AI 모델과 도구 간의 통신을 표준화
- **확장성**: 새로운 도구를 쉽게 추가할 수 있음
- **크로스 플랫폼**: 다양한 환경에서 동작

### MCP 서버 구조

```python
from mcp.server.fastmcp import FastMCP

# MCP 서버 인스턴스 생성
mcp = FastMCP("서버이름")

# 도구 등록
@mcp.tool()
def my_tool():
    """도구 설명"""
    pass

# 서버 실행
if __name__ == "__main__":
    mcp.run(transport="stdio")
```

---

## 🧮 수학 서버 실습 (math-server)

간단한 수학 연산을 수행하는 MCP 서버를 구현했습니다.

### 구현된 도구들

| 도구명     | 기능         | 입력        | 출력         |
| ---------- | ------------ | ----------- | ------------ |
| `add`      | 두 수를 더함 | a, b (정수) | a + b (정수) |
| `Subtract` | 두 수를 뺌   | a, b (정수) | a - b (정수) |

### 코드 구조

```python
@mcp.tool()
def add(a, b) -> int:
    """더하기"""
    try:
        a = int(a)
        b = int(b)
        logging.info(f"Adding {a} and {b}")
        return a + b
    except Exception as e:
        logging.error(f"Invalid input in add: {a}, {b} - {e}")
        raise
```

### 사용 예시

✅ **성공적인 연산 결과:**

- `add(12, 4) = 16`
- `Subtract(15, 5) = 10`

---

## 📚 RAG 시스템 실습 (rag-server)

PDF 문서를 기반으로 한 질문응답 시스템을 구현했습니다.

### RAG 시스템의 구성 요소

1. **문서 로더**: PyPDFLoader를 사용하여 PDF 파일 로드
2. **텍스트 분할**: RecursiveCharacterTextSplitter로 문서를 청크로 분할
3. **임베딩**: OpenAIEmbeddings로 텍스트를 벡터로 변환
4. **벡터 저장소**: Chroma를 사용하여 벡터 데이터 저장
5. **질문응답 체인**: RetrievalQA로 검색 기반 답변 생성

### 🔐 보안을 고려한 API 키 관리

**최신 코드에서는 보안을 강화한 API 키 관리 방식을 사용합니다:**

```python
from dotenv import load_dotenv
import os

# .env 파일에서 환경 변수 로드
load_dotenv()

# 환경 변수에서 API 키 가져오기
os.environ["OPENAI_API_KEY"] = os.getenv("OPENAI_API_KEY")
```

**장점:**

- ✅ API 키를 코드에 하드코딩하지 않음
- ✅ `.env` 파일을 통한 안전한 키 관리
- ✅ 환경별로 다른 설정 가능
- ✅ Git 등 버전 관리 시스템에 키 노출 방지

### 핵심 코드 구조

```python
# PDF 로드 및 분할
loader = PyPDFLoader(PDF_PATH)
pages = loader.load()
splitter = RecursiveCharacterTextSplitter(chunk_size=500, chunk_overlap=50)
docs = splitter.split_documents(pages)

# 임베딩 및 벡터 저장소 생성
embeddings = OpenAIEmbeddings()
vectorstore = Chroma.from_documents(docs, embeddings)

# RAG 체인 생성
qa_chain = RetrievalQA.from_chain_type(
    llm=llm,
    retriever=vectorstore.as_retriever()
)
```

### MCP 도구로 등록

```python
@mcp.tool()
def ask_pdf(query: str) -> str:
    """PDF 내용을 기반으로 질문에 답변합니다."""
    logging.info(f"Received query: {query}")
    return qa_chain.run(query)
```

**도구 기능:**

- PDF 문서 내용을 기반으로 질문에 답변
- 외부 AI 도구(Cursor, Claude 등)에서 호출 가능
- 로깅을 통한 질문 추적 및 디버깅 지원

---

## 🚀 LangChain 프레임워크

LangChain은 LLM을 활용한 애플리케이션 개발을 위한 프레임워크입니다.

### 주요 구성 요소

- **LLM**: GPT, Claude 등의 언어 모델
- **프롬프트**: AI에게 전달할 지시사항
- **체인**: 여러 단계를 연결한 작업 흐름
- **메모리**: 대화 기록 및 컨텍스트 저장
- **도구**: 외부 API, 데이터베이스 연동

### RAG의 작동 원리

1. **문서 처리**: PDF를 텍스트로 변환하고 청크로 분할
2. **벡터화**: 각 청크를 임베딩하여 벡터로 변환
3. **검색**: 질문과 유사한 벡터를 검색
4. **생성**: 검색된 정보를 바탕으로 AI가 답변 생성

---

## ⚙️ 설정 및 실행

### MCP 설정 파일 (mcp.json)

```json
{
  "mcpServers": {
    "math-server": {
      "command": "C:/Python313/python.exe",
      "args": ["C:/Users/admin/test-server/math-server/math_server.py"]
    },
    "rag-server": {
      "command": "C:/Python313/python.exe",
      "args": ["C:/Users/admin/test-server/rag-server/main.py"]
    }
  }
}
```

### 필요한 패키지

```bash
# 핵심 패키지
mcp-server-fastmcp
langchain
langchain-openai
langchain-community
chromadb
pypdf
python-dotenv  # 환경 변수 관리를 위한 패키지
```

### 환경 변수 설정

⚠️ **보안 강화된 설정 방법:**

**1. .env 파일 생성 (권장):**

```bash
# rag-server/.env
OPENAI_API_KEY=sk-your-actual-api-key-here
```

**2. 시스템 환경 변수 설정:**

```bash
# Windows
set OPENAI_API_KEY=sk-your-actual-api-key-here

# Linux/Mac
export OPENAI_API_KEY=sk-your-actual-api-key-here
```

**3. 코드에서 직접 설정 (보안상 권장하지 않음):**

```python
os.environ["OPENAI_API_KEY"] = "sk-your-actual-api-key-here"
```

---

## 📊 실습 결과 및 학습 포인트

### 성공적으로 구현된 기능

✅ MCP 서버를 통한 도구 등록 및 호출
✅ 수학 연산 도구의 정상 작동
✅ PDF 기반 RAG 시스템 구축
✅ LangChain과 MCP의 연동
✅ 보안을 고려한 API 키 관리
✅ dotenv를 통한 환경 변수 관리

### 학습된 핵심 개념

- **MCP 프로토콜**: AI와 도구 간의 표준화된 통신
- **RAG 시스템**: 검색과 생성의 결합
- **벡터 데이터베이스**: 의미적 검색을 위한 임베딩 저장
- **LangChain 체인**: 복잡한 AI 워크플로우 구성
- **보안 모범 사례**: API 키의 안전한 관리 방법

### 향후 발전 방향

- 더 많은 도구 추가 및 연동
- 웹 인터페이스 구축
- 다양한 문서 형식 지원
- 성능 최적화 및 확장성 개선
- 추가적인 보안 기능 구현

---

## 🔍 문제 해결 및 디버깅

### 일반적인 문제들

| 문제                     | 원인                 | 해결 방법                                      |
| ------------------------ | -------------------- | ---------------------------------------------- |
| MCP 도구가 인식되지 않음 | 서버가 실행되지 않음 | MCP 서버 재시작                                |
| API 키 오류              | 환경 변수 미설정     | .env 파일 또는 환경 변수에 OPENAI_API_KEY 설정 |
| PDF 파일을 찾을 수 없음  | 경로 오류            | PDF_PATH 경로 확인                             |
| dotenv 관련 오류         | python-dotenv 미설치 | `pip install python-dotenv` 실행               |

### 로깅 활용

💡 **로깅 설정:**

```python
logging.basicConfig(level=logging.INFO)
```

로그를 통해 실행 과정과 오류를 추적할 수 있습니다.

### API 키 관련 오류 해결

**401 Unauthorized 오류가 발생하는 경우:**

1. `.env` 파일에 올바른 API 키가 설정되어 있는지 확인
2. API 키가 `sk-`로 시작하는지 확인
3. API 키가 51자리인지 확인
4. OpenAI 계정에 충분한 크레딧이 있는지 확인

---

## 🎉 결론

이번 실습을 통해 MCP 서버의 기본 구조와 RAG 시스템의 구현 방법을 학습했습니다. LangChain 프레임워크를 활용하여 AI 모델과 다양한 도구를 연동하는 방법을 이해할 수 있었습니다.

### 핵심 성과

- MCP 프로토콜을 통한 도구 등록 및 관리
- LangChain을 활용한 RAG 시스템 구축
- PDF 문서 기반 질문응답 시스템 구현
- AI 모델과 외부 도구의 연동 방법 습득
- **보안을 고려한 API 키 관리 방법 습득**
- **dotenv를 통한 환경 변수 관리 방법 습득**

### 실무 적용 가능성

이번 실습에서 학습한 내용은 문서 검색 시스템, 지능형 챗봇, 자동화 도구 등 다양한 AI 애플리케이션 개발에 활용할 수 있습니다. 특히 **보안을 고려한 API 키 관리**는 실제 프로덕션 환경에서 매우 중요한 요소입니다.

---

## 📝 작성 정보

- **제목**: MCP 서버와 RAG 시스템 실습 정리
- **작성자**: AI 어시스턴트
- **작성일**: 2024년
- **최종 업데이트**: 2024년 12월 (현재 코드 반영)
- **실습 환경**: Windows 10, Python 3.13.7
- **사용 기술**: MCP, LangChain, OpenAI API, Chroma DB, python-dotenv
- **보안 기능**: 환경 변수를 통한 API 키 관리

---

_이 문서는 MCP 서버와 RAG 시스템 실습 과정을 정리한 것입니다. 최신 코드의 보안 기능과 환경 변수 관리 방법이 반영되어 있습니다._
